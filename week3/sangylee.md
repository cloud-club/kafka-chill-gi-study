# kafka consumer
<!-- note, tip, important, warning, caution-->
어플리케이션은 consumer를 사용해서 topic을 구독하고 해당 토픽에서 메시지를 수신
> [!NOTE]
> 다른 시스템과 다르게 몇가지 고유한 개념와 아이디어가 있음

## consumer 개념
topic에서 메시지를 읽으면 프로그램은 consumer 객체를 생성하고 토픽을 구독해서 메시지 수신 후 처리

topic에 메시지를 생성하는 속도보다 소비하는 속도가 더 빠르다면 consumer를 1개만 쓸 때 처리가 뒤쳐질 것임
* kafka가 consumer group을 도입한 이유

### consumer group
consumer는 일반적으로 consumer group의 일부이다.
* 동일한 토픽을 구독하는 같은 컨슈머 그룹에 속한 컨슈머들은 토픽에 있는 여러 파티션에서 메시지를 수신

#### 컨슈머 그룹 동작 방식
* 단일 컨슈머: 그룹의 유일한 컨슈머는 토픽의 모든 파티션에서 메시지를 받음
* 다수의 컨슈머: 컨슈머 그룹에 컨슈머를 추가하면 파티션이 컨슈머 간에 분배
* 파티션 제한: 컨슈머 수가 파티션 수를 초과하면 일부 컨슈머는 유휴 상태
  * 한 토픽의 파티션이 4개인데 컨슈머가 5개이면 일부 컨슈머는 놀고 있다는 뜻

> [!IMPORTANT]
> 컨슈머 그룹의 이점
> * 확장성: 컨슈머 그룹을 사용하면 여러 컨슈머가 동일한 토픽에서 읽을 수 있어 데이터 소비 확장
> * 부하 분산: 파티션이 컨슈머 간에 분배되어 처리 부하가 분산
> * 고가용성: 컨슈머 그룹은 장애 발생 시 자동으로 재조정되어 가용성을 상승
> * 병렬 처리: 여러 컨슈머가 동시에 다른 파티션에서 데이터를 처리 가능

> [!TIP]
> 여러 어플리케이션이 동일한 토픽의 데이터를 읽어야 할 때
> * 각 애플리케이션이 모든 메시지를 받도록 하려면 애플리케이션마다 고유한 컨슈머 그룹을 사용해야 한다.

<img width="525" alt="image" src="https://github.com/user-attachments/assets/83822155-1164-4656-95be-20c7ca4aa62f" />

고유한 컨슈머 그룹을 쓰면 장점
1. 메시지 전체 수신: 각 애플리케이션은 토픽의 모든 메시지를 받을 수 있음
2. 독립적 처리: 컨슈머 그룹은 서로 독립적으로 메시지를 처리
3. 확장성: Kafka는 성능 저하 없이 많은 수의 컨슈머와 컨슈머 그룹을 지원
#### 예시
기존 컨슈머 그룹에 새로운 컨슈머 그룹 G2를 추가하면
* G2의 단일 컨슈머는 G1과 무관하게 토픽의 모든 메시지를 받음
* G2에 여러 컨슈머가 있다면, 각 컨슈머는 파티션의 하위 집합을 받지만, G2 전체로는 여전히 모든 메시지를 받음

> [!IMPORTANT]
> 요약
> * 하나 이상의 토픽에서 모든 메시지가 필요한 각 애플리케이션에 대해 새로운 컨슈머 그룹을 생성합니다.
> * 기존 컨슈머 그룹에 컨슈머를 추가하여 토픽에서 메시지 읽기와 처리를 확장합니다. 이 경우 그룹 내 각 추가 컨슈머는 메시지의 일부만 받게 됩니다

## 컨슈머 그룹과 파티션 리벨런싱
분산 처리 시스템의 핵심 매커니즘이며 확장성과 고가용성을 제공
* 리벨런싱은 컨슈머 그룹 내에서 파티션 소유권을 재분배하는 프로세스이며 시스템의 변화에 유연하게 대응한다.

### 리밸런싱 트리거 및 프로세스
리밸런싱은 다음과 같은 상황에서 발생합

* 컨슈머 추가/제거: 새로운 컨슈머가 그룹에 합류하거나 기존 컨슈머가 종료/장애 발생 시.
* 토픽 파티션 변경: 관리자가 토픽에 새 파티션을 추가할 때.
* 컨슈머 장기 유휴: 일정 시간 하트비트(heartbeat)를 보내지 않으면 그룹에서 제외됩니다.

리밸런싱 프로세스는 다음과 같이 진행
* 그룹 코디네이터가 리밸런스 시작을 알림 → 모든 컨슈머가 파티션 소유권 포기.
* 그룹 리더(첫 번째 컨슈머)가 PartitionAssignor 전략을 사용해 새 할당 계획 생성.
* 새로운 파티션 배분이 컨슈머들에게 전달되고, 각 컨슈머는 할당된 파티션에서 데이터 처리 재개


* 리벨런싱의 종류는 컨슈머 그룹이 사용하는 파티션 할당 전략에 따라서 2가지가 있음 
